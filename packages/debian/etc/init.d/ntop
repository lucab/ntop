#! /bin/sh

#
# (C) 2003-07 - Luca Deri <deri@ntop.org>
# (C) 2007    - Massimo Torquati <torquati@ntop.org>
#

APPNAME=ntop
PERSISTENT_DIR=/usr/local/share/ntop
SPOOL_DIR=$PERSISTENT_DIR/spool
NTOP_PATH=/usr/local/bin/ntop
NTOP_CONF=/etc/ntop/ntop.conf
NTOP_PIDFILE=/var/run/ntop.pid

####################

start_ntop() {
   if test -f /etc/ntop/ntop.start; then
      start-stop-daemon --start --quiet --name $APPNAME --background --exec $NTOP_PATH @$NTOP_CONF > /dev/null
   fi

   return 0
}

####################

wait_for_deaddaemon () {
    WAITFORDAEMON=15
    pid=$1
    sleep 1
    if test -n "$pid"
	then
	if kill -0 $pid 2>/dev/null
	    then
	    echo -n "."
	    cnt=0
	    while kill -0 $pid 2>/dev/null
	      do
	      cnt=`expr $cnt + 1`
	      if [ $cnt -gt $WAITFORDAEMON ]
		  then
		  echo " FAILED."
		  return 1
	      fi
	      sleep 1
	      echo -n "."
	    done
	fi
    fi

    rm -f $NTOP_PIDFILE
    return 0
}

####################

stop_ntop() { 
    if [ -f $NTOP_PIDFILE ]; then
	pid=`cat $NTOP_PIDFILE 2>/dev/null`
	if [ -n $pid ]; then
	    kill $pid
	fi
	wait_for_deaddaemon $pid
    fi
}

####################

default_ntop() { 
    if [ ! -d $PERSISTENT_DIR/rrd ]; then
	mkdir -p $PERSISTENT_DIR/rrd
    fi
    chown -R nobody $PERSISTENT_DIR/rrd

    if [ ! -f $PERSISTENT_DIR/ntop_pw.db ]; then
	$NTOP_PATH -u nobody -P $PERSISTENT_DIR -Q $SPOOL_DIR --set-admin-password=admin
    fi

    if [ ! -d /etc/ntop ]; then
	mkdir /etc/ntop
	touch /etc/ntop/ntop.start
	echo "-P $PERSISTENT_DIR" > $NTOP_CONF
	echo "-Q $SPOOL_DIR" >> $NTOP_CONF
	echo "-u nobody" >> $NTOP_CONF
    fi

    if [ ! -d $PERSISTENT_DIR ]; then
	mkdir -p $PERSISTENT_DIR
	chmod gou+w $PERSISTENT_DIR
    fi

    if [ ! -d $SPOOL_DIR ]; then
	mkdir -p $SPOOL_DIR
	chmod gou+w $SPOOL_DIR
    fi

    chown -R nobody $PERSISTENT_DIR $SPOOL_DIR
}

########

case "$1" in
  start)
	echo -n "Starting ntop "
	default_ntop;
	start_ntop;
	echo " Done."
	;;
  stop)
        echo -n "Stopping ntop "
       	stop_ntop;
	echo " Done."
	;;

  default)
        echo -n "Defaulting ntop "
       	default_ntop;
	echo " Done."
	;;

  restart)
        echo -n "Restarting ntop "
	stop_ntop;
	start_ntop;
	echo " Done."
	;;

  *)
	echo "Usage: /etc/init.d/ntop {start|stop|restart|default}"
	exit 1
esac

exit 0
